#!/bin/bash

#===[ Constants ]===
PROJECT_NAME="DnsProxy"
BASE_DIR="/usr/local/bin/DnsProxy"
CONFIG_DIR="/etc/coredns/conf.d"

#===[ Colors ]===
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RESET='\033[0m'

#===[ Helpers ]===
function clear_and_header() {
    clear
    echo -e "${CYAN}╔══════════════════════════════╗"
    echo -e "║     🌐  DnsProxy Manager     ║"
    echo -e "╚══════════════════════════════╝${RESET}"
    echo
}

function service_status() {
    echo -e "${YELLOW}🔍 Service Status:${RESET}"
    systemctl is-active --quiet coredns && echo -e "🟢 CoreDNS: ${GREEN}Running${RESET}" || echo -e "🔴 CoreDNS: ${RED}Stopped${RESET}"
    systemctl is-active --quiet sniproxy && echo -e "🟢 SNIProxy: ${GREEN}Running${RESET}" || echo -e "🔴 SNIProxy: ${RED}Stopped${RESET}"
    echo
}

function main_menu() {
    while true; do
        clear_and_header
        service_status
        echo -e "${YELLOW}1) 📥 Install"
        echo -e "2) ❌ Uninstall"
        echo -e "3) 📂 Domains"
        echo -e "4) 🚪 Exit${RESET}"
        echo
        read -p "Choose an option: " choice
        case "$choice" in
            1) bash "$BASE_DIR/Install.sh" ;;
            2) bash "$BASE_DIR/Uninstall.sh" ;;
            3) domains_menu ;;
            4) exit 0 ;;
            *) echo -e "${RED}Invalid option.${RESET}"; sleep 1 ;;
        esac
    done
}

function domains_menu() {
    while true; do
        clear_and_header
        echo -e "${YELLOW}📂 Domains Menu:${RESET}"
        echo -e "1) 📃 List current"
        echo -e "2) ➕ Add domain"
        echo -e "3) 🗑️  Remove domain"
        echo -e "4) 🔙 Back${RESET}"
        echo
        read -p "Choose an option: " dom_choice
        case "$dom_choice" in
            1)
                echo -e "${CYAN}Existing domains:${RESET}"
                for file in "$CONFIG_DIR"/*.conf; do
                    [ -e "$file" ] && basename "$file" .conf
                done
                echo
                read -p "Press enter to return..." ;;
            2)
				echo -ne "${YELLOW}Enter domain to add (e.g. example.com): ${RESET}"
				read domain
				/usr/local/bin/DnsProxy/AddDomain.sh "$domain"
				read -p "Press enter to return..."
				;;
            3)
				echo -ne "${YELLOW}Enter domain to remove (e.g. gemini.google.com): ${RESET}"
				read domain
				rm -f "$CONFIG_DIR/$domain.conf" && echo -e "${GREEN}Removed $domain.conf${RESET}" || echo -e "${RED}Not found.${RESET}"
				systemctl restart coredns
				read -p "Press enter to return..." ;;
            4) return ;;
            *) echo -e "${RED}Invalid option.${RESET}"; sleep 1 ;;
        esac
    done
}

main_menu
